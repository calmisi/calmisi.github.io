<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/8.jpg?v=6.4.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/8.jpg?v=6.4.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=6.4.1">


  <link rel="mask-icon" href="/images/8.jpg?v=6.4.1" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="本文介绍kvm中对MSRs相关的处理，包括MSR bitmap, rdmsr和wrmsr相关的trap和处理等。 MSR bitmap如果处理器支持 1-setting of the “Use MSR bitmaps” VM-execution control, 那么VM-execution control fields会包含4个连续的MSR bitmaps的64位的物理地址，每个连续的MSR b">
<meta name="keywords" content="KVM,msr">
<meta property="og:type" content="article">
<meta property="og:title" content="kvm对guest中MSR寄存器的处理（一）">
<meta property="og:url" content="https://blog.calmisi.cn/post/2019/1/kvm对guest中MSR寄存器的处理（一）.html">
<meta property="og:site_name" content="Calmisi Lee">
<meta property="og:description" content="本文介绍kvm中对MSRs相关的处理，包括MSR bitmap, rdmsr和wrmsr相关的trap和处理等。 MSR bitmap如果处理器支持 1-setting of the “Use MSR bitmaps” VM-execution control, 那么VM-execution control fields会包含4个连续的MSR bitmaps的64位的物理地址，每个连续的MSR b">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-01-22T15:24:38.780Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kvm对guest中MSR寄存器的处理（一）">
<meta name="twitter:description" content="本文介绍kvm中对MSRs相关的处理，包括MSR bitmap, rdmsr和wrmsr相关的trap和处理等。 MSR bitmap如果处理器支持 1-setting of the “Use MSR bitmaps” VM-execution control, 那么VM-execution control fields会包含4个连续的MSR bitmaps的64位的物理地址，每个连续的MSR b">






  <link rel="canonical" href="https://blog.calmisi.cn/post/2019/1/kvm对guest中MSR寄存器的处理（一）.html"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>kvm对guest中MSR寄存器的处理（一） | Calmisi Lee</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Calmisi Lee</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">Never like what you think.</h1>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.calmisi.cn/post/2019/1/kvm对guest中MSR寄存器的处理（一）.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Calmisi Lee">
      <meta itemprop="description" content="Pas de regrets">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Calmisi Lee">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">kvm对guest中MSR寄存器的处理（一）
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-01-18 00:07:49" itemprop="dateCreated datePublished" datetime="2019-01-18T00:07:49+08:00">2019-01-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-01-22 23:24:38" itemprop="dateModified" datetime="2019-01-22T23:24:38+08:00">2019-01-22</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/KVM/" itemprop="url" rel="index"><span itemprop="name">KVM</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/post/2019/1/kvm对guest中MSR寄存器的处理（一）.html" class="leancloud_visitors" data-flag-title="kvm对guest中MSR寄存器的处理（一）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views: </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">8.3k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">8 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文介绍kvm中对MSRs相关的处理，包括MSR bitmap, rdmsr和wrmsr相关的trap和处理等。</p>
<h1 id="MSR-bitmap"><a href="#MSR-bitmap" class="headerlink" title="MSR bitmap"></a>MSR bitmap</h1><p>如果处理器支持 1-setting of the “Use MSR bitmaps” VM-execution control, 那么VM-execution control fields会包含4个连续的MSR bitmaps的64位的物理地址，每个连续的MSR bitmaps为1 KByte的大小。<br>如果处理器不支持1-setting of the “Use MSR bitmaps”,那么不会存在这4个连续的区域。</p>
<ul>
<li>Read bitmap for low MSRs(locate at the MSR-bitmap address). This contains one bit for each MSR address in the range 0000 0000H to 0000 1FFFH. The bit determines whether an execution of RDMSR applied to that MSR causes a VM exit.<br>即从 [MSR-bitmap address ~ MSR-bitmap address+1023] 共1KB(8192 bits)的大小，每个bit对应0000 0000H - 0000 1FFFH中的一个MSR。如果对应的bit为1，那么RDMSR相应地址的MSR则会VM exit.</li>
<li>Read bitmap for high MSRs (located at the MSR-bitmap address plus 1024). This contains one bit for each MSR address in the range C000 0000H to C000 1FFFH. The bit determines whether an execution of RDMSR applied to that MSR causes a VM exit.<br>即从 [MSR-bitmap address+1024 ~ MSR-bitmap address+2047] 共1KB(8192 bits)的大小，每个bit对应C000 0000H - C000 1FFFH中的一个MSR。如果对应的bit为1，那么RDMSR相应地址的MSR则会VM exit.</li>
<li>Write bitmap for low MSRs (located at the MSR-bitmap address plus 2048). 同理控制地址范围0000 0000H - 0000 1FFFH的MSR的WRMSR是否会VM exit.</li>
<li>Write bitmap for high MSRs (located at the MSR-bitmap address plus 3072). 同理控制地址范围C000 0000H - C000 1FFFH的MSR的WRMSR是否会VM exit.</li>
</ul>
<a id="more"></a>
<h1 id="rdmsr-amp-wrmsr-指令"><a href="#rdmsr-amp-wrmsr-指令" class="headerlink" title="rdmsr &amp; wrmsr 指令"></a>rdmsr &amp; wrmsr 指令</h1><p>在<code>SDM.Vol3.25.1.3 Instructions That Cause VM Exits Conditionally</code>中关于rdmsr和wrmsr指令，是这样说的：<br>RDMSR. The RDMSR instruction causes a VM exit if any of the following are true: </p>
<ul>
<li>The “Use MSR bitmaps” VM-execution control is 0.</li>
<li>The value of ECX is not in the ranges 0000 0000H - 0000 1FFFH and C000 0000H - C000 1FFFH.</li>
<li>The value of ECX is in the ranges 0000 0000H - 0000 1FFFH and bit n in read bitmap for low MSRs is 1, where n is the value of ECX.</li>
<li>The value of ECX is in the ranges C000 0000H - C000 1FFFH and bit n in read bitmap for high MSRs is 1, where n is the value of ECX &amp; 0000 1FFFH.</li>
</ul>
<p>WRMSR同上可以类推。</p>
<hr>
<p>当guest在运行时，如果不产生VM EXIT，即运行VM non-root mdoe的时候。如果RDMSR/WRMSR不会产生VM exit,那么会直接对物理的MSR进行读写，<br>如果产生了VM EXIT，那么会VM EXIT，到VM root mode，根据KVM code来决定如何处理，下面我们来看kvm code是如何实现的。<br>//应该放到总结去。</p>
<h1 id="KVM如何处理rdmsr-VM-exit"><a href="#KVM如何处理rdmsr-VM-exit" class="headerlink" title="KVM如何处理rdmsr VM exit."></a>KVM如何处理rdmsr VM exit.</h1><h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><h3 id="数据结构1–-vmx-msr-index-数组"><a href="#数据结构1–-vmx-msr-index-数组" class="headerlink" title="数据结构1– vmx_msr_index[]数组"></a>数据结构1– vmx_msr_index[]数组</h3><ol>
<li>定义<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Though SYSCALL is only supported in 64-bit mode on Intel CPUs, kvm</span><br><span class="line"> * will emulate SYSCALL in legacy mode if the vendor string in guest</span><br><span class="line"> * CPUID.0:&#123;EBX,ECX,EDX&#125; is &quot;AuthenticAMD&quot; or &quot;AMDisbetter!&quot; To</span><br><span class="line"> * support this emulation, IA32_STAR must always be included in</span><br><span class="line"> * vmx_msr_index[], even in i386 builds.</span><br><span class="line"> */</span><br><span class="line">const u32 vmx_msr_index[] = &#123;                                                                                                             </span><br><span class="line">#ifdef CONFIG_X86_64</span><br><span class="line">        MSR_SYSCALL_MASK, MSR_LSTAR, MSR_CSTAR,</span><br><span class="line">#endif</span><br><span class="line">        MSR_EFER, MSR_TSC_AUX, MSR_STAR,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="数据结构2–-kvm-shared-msrs，-percpu变量"><a href="#数据结构2–-kvm-shared-msrs，-percpu变量" class="headerlink" title="数据结构2– kvm_shared_msrs，__percpu变量"></a>数据结构2– kvm_shared_msrs，__percpu变量</h3><ol>
<li><p>定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#define KVM_NR_SHARED_MSRS 16</span><br><span class="line"></span><br><span class="line">struct kvm_shared_msrs &#123;</span><br><span class="line">	struct user_return_notifier run;</span><br><span class="line">	bool registered;</span><br><span class="line">	struct kvm_shared_msr_values &#123;</span><br><span class="line">		u64 host;</span><br><span class="line">		u64 curr;</span><br><span class="line">	&#125; values[KVM_NR_SHARED_MSRS];		//values[16]数组的大小为16，最多可以存16个msr寄存器的值</span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">static struct kvm_shared_msrs __percpu * shared_msrs;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<br>在x86.c中的kvm_arch_init()函数中，为每个CPU分配了一个percpu变量shared_msrs，为kvm_shared_msrs结构体</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int kvm_arch_init(void *opaque)&#123;</span><br><span class="line">	...</span><br><span class="line">	shared_msrs = alloc_percpu(struct kvm_shared_msrs);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>初始化</li>
</ol>
<h3 id="数据结构3–-shared-msrs-global"><a href="#数据结构3–-shared-msrs-global" class="headerlink" title="数据结构3– shared_msrs_global"></a>数据结构3– shared_msrs_global</h3><ol>
<li><p>定义<br>在x86.c中，定义了一个结构体struct kvm_shared_msrs_global和其一个static实例，shared_msrs_global;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#define KVM_NR_SHARED_MSRS	16</span><br><span class="line">struct kvm_shared_msrs_global &#123;</span><br><span class="line">	int nr;</span><br><span class="line">	u32 msrs[KVM_NR_SHARED_MSRS];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static struct kvm_shared_msrs_global __read_mostly shared_msrs_global;</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化<br>然后在hardware_setup()函数中会根据vmx_msr_index[]调用kvm_define_shared_msr(),具体地：<br>将vmx_msr_index[]数组存入shared_msrs_global.msrs[]数组中，其中kvm_msrs_global.nr为vmx_msr_index[]数组的大小，即记录shared_msrs_global.msrs[]数组的大小。</p>
</li>
</ol>
<h3 id="数据结构4–-vmx-gt-guest-msrs"><a href="#数据结构4–-vmx-gt-guest-msrs" class="headerlink" title="数据结构4– vmx-&gt;guest_msrs[]"></a>数据结构4– vmx-&gt;guest_msrs[]</h3><ol>
<li><p>定义<br>vmx-&gt;guest_msrs[]为strcut vcpu_vmx结构体中定义的一个struct shared_msr_entry * guest_msrs的指针。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">struct vcpu_vmx &#123;</span><br><span class="line">	...</span><br><span class="line">	struct shared_msr_entry * guest_msrs;</span><br><span class="line">	int	nmsrs;</span><br><span class="line">	int save_nmsrs;</span><br><span class="line">	bool guest_msrs_dirty;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct shared_msr_entry &#123;</span><br><span class="line">	unsigned index;</span><br><span class="line">	u64 data;</span><br><span class="line">	u64	mask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<br>在vmx_create_vcpu()函数中，vmx-&gt;guest_msrs = kmalloc(PAGE_SIZE, GFP_KERNRL)为其分配了一个4KB的page页。</p>
</li>
<li><p>初始化<br>在vmx.c中的vmx_vcpu_setup()函数中，初始化vmx-&gt;guest_msrs[]数组，<br>具体地，vmx_vcpu_setup()函数，为vcpu配置VMCS的各个域，我们不关心这些，只看其中初始化vmx-&gt;guest_msrs[]数组的过程，具体看下面的for循环：<br>vmx_msr_index[]数组里面的成员的不同的MSR的index，初始时，vmx-&gt;nmsrs=0;<br>所以该函数根据vmx_msr_index[]定义的MSR寄存器，依次进行检查，并将其存入vmx-&gt;guest_msrs[]数组，并用vmx-&gt;nmsrs记录数组大小。<br>首先rdmsr_safe然后将read的值wrmsr_safe,以判断KVM可以正常的读写该MSR；<br>如果可以，就将该MSR的存入vmx-&gt;guest_msrs[]数组，具体地：<br>vmx-&gt;guest_msrs[].index = 为该MSR在vmx_msr_index[]数组中的序号。<br>vmx-&gt;guest_msrs[].data = 0<br>vmx-&gt;guest_msrs[].mask = 全1；</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Sets up the vmcs for emulated real mode.</span><br><span class="line"> */</span><br><span class="line">static void vmx_vcpu_setup(struct vcpu_vmx *vmx)</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	for (i = 0; i &lt; ARRAY_SIZE(vmx_msr_index); ++i) &#123;</span><br><span class="line">	    u32 index = vmx_msr_index[i];</span><br><span class="line">	    u32 data_low, data_high;</span><br><span class="line">	    int j = vmx-&gt;nmsrs;</span><br><span class="line">	</span><br><span class="line">	    if (rdmsr_safe(index, &amp;data_low, &amp;data_high) &lt; 0)</span><br><span class="line">	            continue;</span><br><span class="line">	    if (wrmsr_safe(index, data_low, data_high) &lt; 0)</span><br><span class="line">	            continue;</span><br><span class="line">	    vmx-&gt;guest_msrs[j].index = i;</span><br><span class="line">	    vmx-&gt;guest_msrs[j].data = 0;</span><br><span class="line">	    vmx-&gt;guest_msrs[j].mask = -1ull;</span><br><span class="line">	    ++vmx-&gt;nmsrs;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="对数据结构的操作点"><a href="#对数据结构的操作点" class="headerlink" title="对数据结构的操作点"></a>对数据结构的操作点</h2><p>上面为每个cpu分配的struct kvm_shared_msrs shared_msrs变量在<code>vmx_prepare_switch_to_guest()</code>函数中会根据vmx-&gt;guest_msrs_dirty变量或者vmx-&gt;guest_cpu_state来更新。<br>具体的条件为<code>!vmx-&gt;loaded_cpu_state || vmx-&gt;guest_msrs_dirty</code>，其中第一种条件为：</p>
<ol>
<li>!vmx-&gt;loaded_cpu_state,当前vmx-&gt;loaded_cpu_state为空，(loaded_cpu_state points to the VMCS whose state is loaded into the CPU registers that only need to be switched when transitioning to/from the kernel; a NULL value indicates that host state is loaded.)</li>
<li>vmx-&gt;guest_msrs_dirty标志位，（）和vmx-&gt;save_nmsrs相关联，<ul>
<li>在vmx.c中的setup_msrs()函数中，会根据vmx_msr_index[]数组来依次判断MSR_STAR,MSR_LSTAR,MSR_SYSCAL_MASK,MSR_EFER,MSR_TSC_AUX这5个MSR是否在vmx-&gt;guest_msrs[]如果在，则依次将它们调换到vmx-&gt;guest_msrs[]数组的前排位置去，最后设置vmx-&gt;save_nmsrs为调换的次数，以及设置vmx-&gt;guest_msrs_dirty=ture.(注意，没有发生调换的时候，即前面提到的5个MSR都不支持的时候，vmx-&gt;save_nmsrs=0，vmx-&gt;guest_msrs_dirty=true)<br>-</li>
</ul>
</li>
</ol>
<p>具体的更新vmx-&gt;guest_msrs[]数组kvm_set_shared_msr()函数，首先取出当前cpu的percpu变量per_cpu_ptr(shared_msrs, cpu);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">void vmx_prepare_switch_to_guest(struct kvm_vcpu * vcpu）</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	/*   </span><br><span class="line">     * Note that guest MSRs to be saved/restored can also be changed</span><br><span class="line">     * when guest state is loaded. This happens when guest transitions</span><br><span class="line">     * to/from long-mode by setting MSR_EFER.LMA.</span><br><span class="line">     */</span><br><span class="line">    if (!vmx-&gt;loaded_cpu_state || vmx-&gt;guest_msrs_dirty) &#123;</span><br><span class="line">            vmx-&gt;guest_msrs_dirty = false;</span><br><span class="line">            for (i = 0; i &lt; vmx-&gt;save_nmsrs; ++i) </span><br><span class="line">                    kvm_set_shared_msr(vmx-&gt;guest_msrs[i].index,                                                                                        </span><br><span class="line">                                       vmx-&gt;guest_msrs[i].data,</span><br><span class="line">                                       vmx-&gt;guest_msrs[i].mask);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// kvm_set_shared_msr()函数，首先从当前CPU取出percpu变量struct kvm_shared_msrs指针(*smsr),在kvm_arch_init()为每个CPU分配。</span><br><span class="line">// 首先判断要set的slot的值value和smrs-&gt;values[slot].curr的当前值是否相同，如果相同，则直接return 0；</span><br><span class="line">// 如果不同，则更新smrs-&gt;values[slot].curr为value,</span><br><span class="line">// 然后将value的值写到具体的MSR中,wrmsl_safe(shared_msrs_global.msrs[slot], value)</span><br><span class="line">// 然后判断当前cpu的percpu变量kvm_shared_msrs是不是已经注册了，如果没有注册则注册。</span><br><span class="line"></span><br><span class="line">int kvm_set_shared_msr(unsigned slot, u64 value, u64 mask)                                                                                                  </span><br><span class="line">&#123;</span><br><span class="line">        unsigned int cpu = smp_processor_id();</span><br><span class="line">        struct kvm_shared_msrs *smsr = per_cpu_ptr(shared_msrs, cpu);</span><br><span class="line">        int err; </span><br><span class="line"></span><br><span class="line">        if (((value ^ smsr-&gt;values[slot].curr) &amp; mask) == 0)</span><br><span class="line">                return 0;</span><br><span class="line">        smsr-&gt;values[slot].curr = value;</span><br><span class="line">        err = wrmsrl_safe(shared_msrs_global.msrs[slot], value);</span><br><span class="line">        if (err)</span><br><span class="line">                return 1;</span><br><span class="line"></span><br><span class="line">        if (!smsr-&gt;registered) &#123;</span><br><span class="line">                smsr-&gt;urn.on_user_return = kvm_on_user_return;</span><br><span class="line">                user_return_notifier_register(&amp;smsr-&gt;urn);</span><br><span class="line">                smsr-&gt;registered = true;</span><br><span class="line">        &#125;    </span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(kvm_set_shared_msr);</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat_pay.jpg" alt="Calmisi Lee WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/ali_pay.jpg" alt="Calmisi Lee Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Calmisi Lee</li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://blog.calmisi.cn/post/2019/1/kvm对guest中MSR寄存器的处理（一）.html" title="kvm对guest中MSR寄存器的处理（一）">https://blog.calmisi.cn/post/2019/1/kvm对guest中MSR寄存器的处理（一）.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/KVM/" rel="tag"># KVM</a>
          
            <a href="/tags/msr/" rel="tag"># msr</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/post/2018/10/size-of-segment.html" rel="next" title="size of segment">
                <i class="fa fa-chevron-left"></i> size of segment
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/post/2019/1/kvm对guest中MSR寄存器的处理（二）-rdmsr.html" rel="prev" title="kvm对guest中MSR寄存器的处理（二）-- rdmsr">
                kvm对guest中MSR寄存器的处理（二）-- rdmsr <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zOTc5MS8xNjMxOA=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="Calmisi Lee" />
            
              <p class="site-author-name" itemprop="name">Calmisi Lee</p>
              <p class="site-description motion-element" itemprop="description">Pas de regrets</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">53</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">18</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">51</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/calmisi" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:calmisi@163.com" target="_blank" title="E-Mail" rel="external nofollow"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MSR-bitmap"><span class="nav-number">1.</span> <span class="nav-text">MSR bitmap</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rdmsr-amp-wrmsr-指令"><span class="nav-number">2.</span> <span class="nav-text">rdmsr &amp; wrmsr 指令</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#KVM如何处理rdmsr-VM-exit"><span class="nav-number">3.</span> <span class="nav-text">KVM如何处理rdmsr VM exit.</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#数据结构"><span class="nav-number">3.1.</span> <span class="nav-text">数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据结构1–-vmx-msr-index-数组"><span class="nav-number">3.1.1.</span> <span class="nav-text">数据结构1– vmx_msr_index[]数组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据结构2–-kvm-shared-msrs，-percpu变量"><span class="nav-number">3.1.2.</span> <span class="nav-text">数据结构2– kvm_shared_msrs，__percpu变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据结构3–-shared-msrs-global"><span class="nav-number">3.1.3.</span> <span class="nav-text">数据结构3– shared_msrs_global</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据结构4–-vmx-gt-guest-msrs"><span class="nav-number">3.1.4.</span> <span class="nav-text">数据结构4– vmx-&gt;guest_msrs[]</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对数据结构的操作点"><span class="nav-number">3.2.</span> <span class="nav-text">对数据结构的操作点</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015=6 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Calmisi Lee</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Symbols count total: </span>
    
    <span title="Symbols count total">190k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    
    <span title="Reading time total">2:53</span>
  
</div>


  



  <div class="powered-by">Powered by <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a class="theme-link" target="_blank" rel="external nofollow" href="https://theme-next.org">NexT.Gemini</a></div>




        








        
      </div>
    </footer>

    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script>



  



  
    <script type="text/javascript">
      window.livereOptions = {
        refer: 'post/2019/1/kvm对guest中MSR寄存器的处理（一）.html'
      };
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script>
    
    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function ({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text(counter.time + 1);
            
            Counter('put', `/classes/Counter/${counter.objectId}`, JSON.stringify({ time: { "__op":"Increment", "amount":1 } }))
            
            .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
            })
          } else {
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text('Counter not initialized! See more at console err msg.');
              console.error('ATTENTION! LeanCloud counter has security bug, see here how to solve it: https://github.com/theme-next/hexo-leancloud-counter-security. \n But you also can use LeanCloud without security, by set \'security\' option to \'false\'.');
            
          }
        })
      .fail(function ({ responseJSON }) {
        console.log('LeanCloud Counter Error:' + responseJSON.code + " " + responseJSON.error);
      });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "tf4TRbjrkONfr7VekxlWI8Py-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "tf4TRbjrkONfr7VekxlWI8Py-gzGzoHsz",
                'X-LC-Key': "5c1wL7zY6VY7oLzi5xaCIu5x",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          addCount(Counter);
          
        })
    });
  </script>



  

  

  
  

  
  

  


  
  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('Copied')
          else $(this).text('Copy failed')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('Copy')
        }, 300)
      }).append(e)
    })
  </script>


</body>
</html>
